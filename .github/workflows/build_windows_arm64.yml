name: Build Windows ARM64

on:
  push:
  pull_request: 
  workflow_dispatch:

jobs:
  build:
    name: Build Windows ARM64
    runs-on: windows-latest
    outputs:
      binary-artifact: ${{ steps.binary-artifact.outputs.artifact-url }}
      msix-conclusion: ${{ steps.msix.conclusion }}
      installer-conclusion: ${{ steps.installer.conclusion }}
    steps:
      - name: 签出仓库
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: 初始化 GitVersion
        uses: gittools/actions/gitversion/setup@v4.2.0
        with:
          versionSpec: '6.4.x'

      - name: 计算版本 Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v4.2.0
        with:
          overrideConfig: |
            assembly-versioning-scheme=MajorMinorPatchTag
            assembly-file-versioning-format="{Major}.{Minor}.{Patch}.{BuildMetaData ?? 0}"

      - name: 初始化 Flutter 环境
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          architecture: x64

      - name: 初始化 Rust 工具链
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-pc-windows-msvc

      - name: 还原依赖
        run: flutter pub get --no-example --enforce-lockfile

      - name: 生成代码
        run: dart run build_runner build --delete-conflicting-outputs

      - name: 构建项目
        shell: pwsh
        env:
          # 1. 强制使用 VS2022 生成器
          # 2. 只有 VS 生成器支持通过环境变量指定 ARM64 目标架构
          CMAKE_GENERATOR: "Visual Studio 17 2022"
          CMAKE_GENERATOR_PLATFORM: ARM64
        run: |-
          flutter build windows `
            --no-pub `
            --build-name=${{ steps.gitversion.outputs.majorMinorPatch }} `
            --build-number=${{ steps.gitversion.outputs.buildMetaData }}

      - name: 修正输出目录结构 (Fix Path)
        shell: pwsh
        run: |-
          Write-Host "Checking build output..."
          # 此时 Flutter 还是把 ARM64 的产物放在了 x64 文件夹里
          $x64Path = "build/windows/x64"
          $arm64Path = "build/windows/arm64"

          if (Test-Path $x64Path) {
              Write-Host "Build output found at $x64Path. Renaming to $arm64Path..."
              
              # 如果 arm64 目录意外存在（例如缓存残留），先强制删除
              if (Test-Path $arm64Path) {
                  Remove-Item -Path $arm64Path -Recurse -Force
              }

              # 将 x64 目录重命名为 arm64
              Rename-Item -Path $x64Path -NewName "arm64"
              
              Write-Host "Directory renamed successfully."
          } else {
              Write-Error "CRITICAL: Build output directory '$x64Path' not found!"
              exit 1
          }

      - name: 上传产物
        id: binary-artifact
        uses: actions/upload-artifact@v6
        with:
          name: binary
          # 经过上面的重命名，现在文件确实在 arm64 目录里了
          path: build/windows/arm64/runner/Release/**/*
          compression-level: 9

      - name: 还原证书
        id: restore-cert
        shell: pwsh
        if: env.CERTIFICATE != ''
        env:
          CERTIFICATE: ${{ secrets.CERTIFICATE }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |-
          $certFile = (New-TemporaryFile).FullName + '.pfx'
          [System.IO.File]::WriteAllBytes($certFile, [System.Convert]::FromBase64String($env:CERTIFICATE))
          $Private:Password = ConvertTo-SecureString -String $env:CERTIFICATE_PASSWORD -AsPlainText
          $Private:Certificate = Get-PfxCertificate $certFile -Password $Private:Password
          $Private:Certificate.Subject
          Write-Output "CERTIFICATE_PATH=$certFile" >> "$env:GITHUB_OUTPUT"
          Write-Output "CERTIFICATE_SUBJECT=$($Private:Certificate.Subject)" >> "$env:GITHUB_OUTPUT"

      - name: 构建 MSIX
        id: msix
        shell: pwsh
        if: steps.restore-cert.conclusion == 'success'
        env:
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |-
          # 指定架构为 arm64，msix 工具会去 build/windows/arm64 寻找文件
          # 我们上面的重命名操作确保了这一点
          dart run msix:create `
            --certificate-path '${{ steps.restore-cert.outputs.CERTIFICATE_PATH }}' `
            --certificate-password $env:CERTIFICATE_PASSWORD `
            --build-windows false `
            --architecture arm64 `
            --version '${{ steps.gitversion.outputs.assemblySemVer }}' `
            --publisher '${{ steps.restore-cert.outputs.CERTIFICATE_SUBJECT }}'

      - name: 上传 MSIX
        id: msix-artifact
        if: steps.msix.conclusion == 'success'
        uses: actions/upload-artifact@v6
        with:
          name: msix
          path: build/windows/arm64/runner/Release/pixez.msix
          compression-level: 9

      - name: 生成 MSIX 安装器
        id: installer
        if: steps.msix.conclusion == 'success'
        uses: frg2089/MsixInstaller@v2
        with:
          msix: build/windows/arm64/runner/Release/pixez.msix

      - name: 上传 MSIX 安装器
        id: installer-artifact
        if: steps.installer.conclusion == 'success'
        uses: actions/upload-artifact@v6
        with:
          name: installer
          path: ${{ steps.installer.outputs.path }}
          compression-level: 9

      - name: 生成校验和
        shell: pwsh
        run: |-
          Write-Output '### Build Success (ARM64) :rocket:' >> $env:GITHUB_STEP_SUMMARY

          if ($env:CERTIFICATE_SUBJECT) {
            Write-Output "Publisher: $env:CERTIFICATE_SUBJECT" >> $env:GITHUB_STEP_SUMMARY  
          }

          Write-Output '|File|SHA256|' >> $env:GITHUB_STEP_SUMMARY
          Write-Output '|:-|:-:|' >> $env:GITHUB_STEP_SUMMARY
          Write-Output "|[binary](${{ steps.binary-artifact.outputs.artifact-url }})|${{ steps.binary-artifact.outputs.artifact-digest }}|" >> $env:GITHUB_STEP_SUMMARY

          if ('${{ steps.msix-artifact.conclusion }}' -eq 'success') {
            Write-Output "|[msix](${{ steps.msix-artifact.outputs.artifact-url }})|${{ steps.msix-artifact.outputs.artifact-digest }}|" >> $env:GITHUB_STEP_SUMMARY  
          }

          if ('${{ steps.installer-artifact.conclusion }}' -eq 'success') {
            Write-Output "|[installer](${{ steps.installer-artifact.outputs.artifact-url }})|${{ steps.installer-artifact.outputs.artifact-digest }}|" >> $env:GITHUB_STEP_SUMMARY  
          }

          Write-Output '' >> $env:GITHUB_STEP_SUMMARY
          Write-Output '### MSIX 安装教程' >> $env:GITHUB_STEP_SUMMARY
          Write-Output '![image](https://github.com/Notsfsssf/pixez-flutter/assets/42184238/f1956682-f527-487d-997b-523319cd78d3)' >> $env:GITHUB_STEP_SUMMARY

  publish:
    needs: build
    name: 发布
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
      discussions: write
    runs-on: ubuntu-latest
    steps:
      - name: 签出仓库
        uses: actions/checkout@v6

      - name: Download a Loose Artifact
        shell: pwsh
        run: Invoke-WebRequest -UseBasicParsing -Uri '${{ needs.build.outputs.binary-artifact }}' -OutFile "artifacts/windows-arm64.zip"

      - name: Download a Msix Artifact
        if: needs.build.outputs.msix-conclusion == 'success'
        uses: actions/download-artifact@v7
        with:
          name: msix
          path: artifacts

      - name: Download a Msix Installer Artifact
        if: needs.build.outputs.installer-conclusion == 'success'
        uses: actions/download-artifact@v7
        with:
          name: installer
          path: artifacts

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*