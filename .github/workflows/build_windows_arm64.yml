name: Build Windows ARM64

on:
  push:
  pull_request: 
  workflow_dispatch:

jobs:
  build:
    name: Build Windows ARM64
    runs-on: windows-latest
    outputs:
      binary-artifact: ${{ steps.binary-artifact.outputs.artifact-url }}
      msix-conclusion: ${{ steps.msix.conclusion }}
      installer-conclusion: ${{ steps.installer.conclusion }}
    steps:
      - name: 签出仓库
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: 初始化 GitVersion
        uses: gittools/actions/gitversion/setup@v4.2.0
        with:
          versionSpec: '6.4.x'

      - name: 计算版本 Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v4.2.0
        with:
          overrideConfig: |
            assembly-versioning-scheme=MajorMinorPatchTag
            assembly-file-versioning-format="{Major}.{Minor}.{Patch}.{BuildMetaData ?? 0}"

      - name: 初始化 Flutter 环境
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          architecture: x64

      - name: 初始化 Rust 工具链
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-pc-windows-msvc

      - name: 还原依赖
        run: flutter pub get --no-example --enforce-lockfile

      - name: 生成代码
        run: dart run build_runner build --delete-conflicting-outputs

      # 【核心修复 1】移除 Ninja
      # 强迫 Flutter 使用 Visual Studio 生成器，否则它会忽略 ARM64 设置
      - name: 移除 Ninja (Force MSVC)
        shell: pwsh
        run: |-
          $ninja = Get-Command ninja -ErrorAction SilentlyContinue
          if ($ninja) {
            Write-Host "Found Ninja at $($ninja.Source). Removing it from PATH to force MSVC..."
            # 在当前会话中移除 Ninja 所在的路径
            $env:Path = ($env:Path -split ';' | Where-Object { $_ -ne (Split-Path $ninja.Source) }) -join ';'
            Write-Host "Ninja removed from PATH."
          } else {
            Write-Host "Ninja not found. Good."
          }

      # 【核心修复 2】强制修改 CMakeLists.txt
      # 确保在使用 MSVC 时，ARM64 配置被正确写入
      - name: 强制修改 CMake 配置以支持 ARM64
        shell: pwsh
        run: |-
          $cmakePath = "windows/CMakeLists.txt"
          if (Test-Path $cmakePath) {
            $content = Get-Content $cmakePath -Raw
            $pattern = "(cmake_minimum_required\s*\(.*?\))"
            # 强制设置 Generator Platform 为 ARM64
            $replacement = "$1`nset(CMAKE_GENERATOR_PLATFORM `"ARM64`" CACHE STRING `"`" FORCE)"
            
            if ($content -match $pattern) {
              $newContent = $content -replace $pattern, $replacement
              Set-Content $cmakePath $newContent
              Write-Host "Success: Patched CMakeLists.txt."
            } else {
              Write-Error "Error: Could not patch CMakeLists.txt"
              exit 1
            }
          }

      - name: 构建项目
        shell: pwsh
        env:
          # 配合上面的移除 Ninja，这里显式声明使用 VS
          CMAKE_GENERATOR: "Visual Studio 17 2022"
        run: |-
          flutter build windows `
            --no-pub `
            --build-name=${{ steps.gitversion.outputs.majorMinorPatch }} `
            --build-number=${{ steps.gitversion.outputs.buildMetaData }}

      # 修正 Flutter 错误的输出路径
      - name: 修正输出目录结构 (Fix Path)
        shell: pwsh
        run: |-
          $x64Path = "build/windows/x64"
          $arm64Path = "build/windows/arm64"
          
          # 检查 x64 路径（因为 Flutter 即使在 ARM64 模式下也可能输出到 x64 文件夹）
          if (Test-Path "$x64Path/runner/Release") {
              Write-Host "Artifacts found in x64 folder. Renaming to arm64..."
              if (Test-Path $arm64Path) { Remove-Item -Path $arm64Path -Recurse -Force }
              Rename-Item -Path $x64Path -NewName "arm64"
          } elseif (Test-Path "$arm64Path/runner/Release") {
              Write-Host "Artifacts already in arm64 folder."
          } else {
              Write-Error "Build failed: No artifacts found in x64 or arm64 folders."
              exit 1
          }

      - name: 上传产物
        id: binary-artifact
        uses: actions/upload-artifact@v6
        with:
          name: binary
          path: build/windows/arm64/runner/Release/**/*
          compression-level: 9

      # 证书步骤：如果你没有配置 Secrets，这步及之后都会被跳过
      - name: 还原证书
        id: restore-cert
        shell: pwsh
        # 只有配置了 CERTIFICATE Secret 才会运行
        if: env.CERTIFICATE != ''
        env:
          CERTIFICATE: ${{ secrets.CERTIFICATE }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |-
          $certFile = (New-TemporaryFile).FullName + '.pfx'
          [System.IO.File]::WriteAllBytes($certFile, [System.Convert]::FromBase64String($env:CERTIFICATE))
          $Private:Password = ConvertTo-SecureString -String $env:CERTIFICATE_PASSWORD -AsPlainText
          $Private:Certificate = Get-PfxCertificate $certFile -Password $Private:Password
          $Private:Certificate.Subject
          Write-Output "CERTIFICATE_PATH=$certFile" >> "$env:GITHUB_OUTPUT"
          Write-Output "CERTIFICATE_SUBJECT=$($Private:Certificate.Subject)" >> "$env:GITHUB_OUTPUT"

      - name: 构建 MSIX
        id: msix
        shell: pwsh
        # 只有证书步骤成功才会运行
        if: steps.restore-cert.conclusion == 'success'
        env:
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |-
          dart run msix:create `
            --certificate-path '${{ steps.restore-cert.outputs.CERTIFICATE_PATH }}' `
            --certificate-password $env:CERTIFICATE_PASSWORD `
            --build-windows false `
            --architecture arm64 `
            --version '${{ steps.gitversion.outputs.assemblySemVer }}' `
            --publisher '${{ steps.restore-cert.outputs.CERTIFICATE_SUBJECT }}'

      - name: 上传 MSIX
        id: msix-artifact
        if: steps.msix.conclusion == 'success'
        uses: actions/upload-artifact@v6
        with:
          name: msix
          path: build/windows/arm64/runner/Release/pixez.msix
          compression-level: 9

      - name: 生成 MSIX 安装器
        id: installer
        if: steps.msix.conclusion == 'success'
        uses: frg2089/MsixInstaller@v2
        with:
          msix: build/windows/arm64/runner/Release/pixez.msix

      - name: 上传 MSIX 安装器
        id: installer-artifact
        if: steps.installer.conclusion == 'success'
        uses: actions/upload-artifact@v6
        with:
          name: installer
          path: ${{ steps.installer.outputs.path }}
          compression-level: 9

      - name: 生成校验和
        shell: pwsh
        run: |-
          Write-Output '### Build Success (ARM64) :rocket:' >> $env:GITHUB_STEP_SUMMARY

          if ($env:CERTIFICATE_SUBJECT) {
            Write-Output "Publisher: $env:CERTIFICATE_SUBJECT" >> $env:GITHUB_STEP_SUMMARY  
          }

          Write-Output '|File|SHA256|' >> $env:GITHUB_STEP_SUMMARY
          Write-Output '|:-|:-:|' >> $env:GITHUB_STEP_SUMMARY
          Write-Output "|[binary](${{ steps.binary-artifact.outputs.artifact-url }})|${{ steps.binary-artifact.outputs.artifact-digest }}|" >> $env:GITHUB_STEP_SUMMARY

          # 这里的判断是为了防止跳过步骤后日志报错
          if ('${{ steps.msix-artifact.conclusion }}' -eq 'success') {
            Write-Output "|[msix](${{ steps.msix-artifact.outputs.artifact-url }})|${{ steps.msix-artifact.outputs.artifact-digest }}|" >> $env:GITHUB_STEP_SUMMARY  
          }

          if ('${{ steps.installer-artifact.conclusion }}' -eq 'success') {
            Write-Output "|[installer](${{ steps.installer-artifact.outputs.artifact-url }})|${{ steps.installer-artifact.outputs.artifact-digest }}|" >> $env:GITHUB_STEP_SUMMARY  
          }

          Write-Output '' >> $env:GITHUB_STEP_SUMMARY
          Write-Output '### MSIX 安装教程' >> $env:GITHUB_STEP_SUMMARY
          Write-Output '![image](https://github.com/Notsfsssf/pixez-flutter/assets/42184238/f1956682-f527-487d-997b-523319cd78d3)' >> $env:GITHUB_STEP_SUMMARY

  publish:
    needs: build
    name: 发布
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
      discussions: write
    runs-on: ubuntu-latest
    steps:
      - name: 签出仓库
        uses: actions/checkout@v6

      - name: Download a Loose Artifact
        shell: pwsh
        run: Invoke-WebRequest -UseBasicParsing -Uri '${{ needs.build.outputs.binary-artifact }}' -OutFile "artifacts/windows-arm64.zip"

      - name: Download a Msix Artifact
        if: needs.build.outputs.msix-conclusion == 'success'
        uses: actions/download-artifact@v7
        with:
          name: msix
          path: artifacts

      - name: Download a Msix Installer Artifact
        if: needs.build.outputs.installer-conclusion == 'success'
        uses: actions/download-artifact@v7
        with:
          name: installer
          path: artifacts

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*